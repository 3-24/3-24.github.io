---
layout: single
title: 시스템 프로그래밍 노트 5 - 함수와 스택 메모리
classes: wide
use_math: true
tags:
- stack
categories:
- lecturenotes
- 시스템프로그래밍
---

> 어떻게 함수가 호출되고 인자가 전달될 것인지에 대해 살펴본다.

기본적으로 함수는 stack을 통해 관리된다.

## 1. stack

* 메모리에 있다.
* 높은 주소에서 낮은 주소로 자란다.
* %rsp는 가장 낮은 스택 주소를 가리킨다.
* %rbp는 선택적으로 가장 높은 스택 프레임 주소로 사용된다.

### 1.1. Related Instructions

* push
  * pushq Src
  * `%rsp`를 8 감소시키고 `%rsp`에 Src에 있는 값을 적는다.
* pop
  * popq Dest
  * `%rsp`에 적힌 값을 Dest에 적고 `%rsp`를 8 증가시킨다. 이 때, Dest는 레지스터이다.
* call
  * call label
  * 리턴 주소를 stack에 push하고 label로 jump한다.
* ret
  * 스택에서 리턴 주소를 pop하고 그 주소로 이동한다.

### 1.2. 인자 전달

* 처음 6개의 인자는 순서대로 %rdi, %rsi, %rdx, %rcx, r8, r9이다.
* 7번째 이후의 인자는 스택에 저장된다.
  * Return Addr 위에 차곡차곡 쌓인다.
  * %rbp에서 상대적인 값을 더해서 접근한다. 즉, 함수가 시작될 때 다음과 같은 코드를 사용하여 이전 %rbp값을 저장한 후 %rsp와 %rbp 값을 맞춘 다음 %rbp 위에 예전 %rbp 위에 return address 위에 있는 인자들에 접근한다.

```nasm
push %rbp
mov %rsp, %rbp
...
pop %rbp
```

* return 값은 %rax이다.

### 1.3. Saving Conventions

같은 레지스터를 다른 프레임의 함수에서 사용하면 충돌한다. 이를 방지하기 위해서 레지스터 별로 saving cocnvention 이 있다.

* Caller Saved
  * 부르는 쪽이 저장한다.
  * rax랑 argument registers rdi, rsi, rdx, rcx, r8, r9, 그리고 r10, r11까지이다.
* Callee Saved
  * 부름당한 쪽이 값을 저장하고 return하기 전에 값을 불러온다.
  * rbx랑 r12, r13, r14, 그리고 스택 포인터로 사용되는 rbp랑 rsp도 여기에 해당한다.